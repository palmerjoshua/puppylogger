const db=new Dexie("PuppyLoggerDB");db.version(1).stores({activities:"++id, type, createddate, starttimeSortable, endtimeSortable, notes, [createddate+starttimeSortable]"});let editing={date:null,id:null,showEndTime:!1},lastEditing={date:null,id:null},showNoteInput=!1;const activities=[{emoji:"🍴",label:"Feed"},{emoji:"🛏",label:"Sleep"},{emoji:"⚽",label:"Play"},{emoji:"🎓",label:"Train"},{emoji:"🚶",label:"Walk"},{emoji:"💧",label:"Pee"},{emoji:"💩",label:"Poop"}];function toSortable(e){let[t,n]=e.split(" "),[a,o]=t.split(":").map(Number);return"PM"===n&&a<12&&(a+=12),"AM"===n&&12===a&&(a=0),String(a).padStart(2,"0")+":"+String(o).padStart(2,"0")}async function logActivity(e){const t=new Date,n=toSortable(t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})),a=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;await db.activities.add({type:e,createddate:a,starttimeSortable:n,endtimeSortable:null,notes:null}),await renderLogs()}async function renderLogs(){const e=await db.activities.orderBy("[createddate+starttimeSortable]").reverse().toArray(),t=e.reduce(((e,t)=>((e[t.createddate]||=[]).push(t),e)),{}),n=Object.keys(t),a=editing.date!==lastEditing.date||editing.id!==lastEditing.id,o=document.getElementById("logList");o.innerHTML="",n.forEach(((e,i)=>{const d=document.createElement("section");d.className="bg-white shadow rounded-lg p-4",d.setAttribute("data-date",e),d.id=`section-${e}`;const l=document.createElement("h3");if(l.className="text-md font-bold mb-2",l.textContent=formatDate(e),d.appendChild(l),t[e].forEach((t=>{const n=document.createElement("div");if(n.className="border-b last:border-0 pb-2 flex flex-col",editing.date===e&&editing.id===t.id){n.classList.add("editing","bg-blue-100","mt-2"),a&&n.classList.add("animate-open"),a&&(editDraft={timeSortable:t.starttimeSortable,type:t.type,note:t.notes||"",endSortable:t.endtimeSortable||"",showEndTime:!!t.endtimeSortable});const e=document.createElement("input");e.type="time",e.value=editDraft.timeSortable,e.className="border rounded p-1 mb-2 bg-white",e.setAttribute("data-ga-event","entry_start_time_edit"),e.oninput=e=>{editDraft.timeSortable=e.target.value},n.appendChild(e);let o=null;editing.showEndTime&&(o=document.createElement("input"),o.type="time",o.value=editDraft.endSortable||editDraft.timeSortable,o.className="border rounded p-1 mb-2 bg-white",o.setAttribute("data-ga-event","entry_end_time_edit"),o.oninput=e=>{editDraft.endSortable=e.target.value},n.appendChild(o));const i=document.createElement("button");i.type="button",i.textContent=editing.showEndTime?"Remove End Time":"Add End Time",i.className="text-blue-700 text-sm underline mb-2 text-left",i.setAttribute("data-ga-event",editing.showEndTime?"entry_end_time_remove_click":"entry_end_time_add_click"),i.onclick=()=>{editDraft.showEndTime=!editDraft.showEndTime,editing.showEndTime=editDraft.showEndTime,renderLogs()},n.appendChild(i);const d=document.createElement("select");d.className="border rounded p-1 mb-2 bg-white",d.setAttribute("data-ga-event","entry_activity_edit_click"),activities.forEach((e=>{const t=document.createElement("option");t.value=`${e.emoji} ${e.label}`,t.textContent=t.value,t.value===editDraft.type&&(t.selected=!0),d.appendChild(t)})),d.onchange=e=>{editDraft.type=e.target.value},n.appendChild(d);const l=document.createElement("button");l.type="button",l.textContent=editDraft.note?"Edit Note":"Add Note",l.className="text-blue-700 text-sm underline mb-2 text-left",l.setAttribute("data-ga-event",editDraft.note?"entry_note_edit_click":"entry_note_add_click"),l.onclick=()=>{showNoteInput=!0,renderLogs()},n.appendChild(l);const r=document.createElement("textarea");r.className="border rounded p-1 mb-2 w-full "+(showNoteInput?"":"hidden"),r.placeholder="Enter note...",r.value=editDraft.note,r.oninput=e=>{editDraft.note=e.target.value},n.appendChild(r);const c=document.createElement("div");c.className="flex space-x-2";const s=document.createElement("button");s.type="button",s.textContent="Save",s.className="text-green-800 underline",s.setAttribute("data-ga-event","entry_edit_save_click"),s.onclick=async()=>{await saveEdit(t.id,editDraft.timeSortable,editDraft.type,editDraft.note,editDraft.showEndTime?editDraft.endSortable:"")};const m=document.createElement("button");m.type="button",m.textContent="Cancel",m.className="text-gray-800 underline",m.setAttribute("data-ga-event","entry_edit_cancel_click"),m.onclick=cancelEdit;const u=document.createElement("button");u.type="button",u.textContent="Delete",u.className="text-red-700 underline",u.setAttribute("data-ga-event","entry_edit_delete_click"),u.onclick=async()=>{await deleteEntry(t.id)},c.append(s,m,u),n.appendChild(c)}else{const e=document.createElement("div");e.className="flex justify-between items-center";const a=document.createElement("div");a.className="flex flex-col";const o=convertTo12hFormat(t.starttimeSortable),i=t.endtimeSortable?convertTo12hFormat(t.endtimeSortable):null,d=i?`${o} - ${i}`:o;let l="";if(t.notes){const e=t.notes.length>50?t.notes.slice(0,50)+"...":t.notes;l=`<span class="ml-1 italic text-gray-500 truncate-note" title="${t.notes}">"${e}"</span>`}a.innerHTML=`\n          <span class="font-semibold">${d}</span>\n          <div class="flex flex-wrap items-center">\n            <span>${t.type}</span> ${l}\n          </div>`;const r=document.createElement("button");r.type="button",r.className="text-blue-700 hover:text-blue-800",r.innerText="✏️",r.setAttribute("data-ga-event","entry_edit_click"),r.onclick=()=>{editing={date:t.createddate,id:t.id,showEndTime:!!t.endtimeSortable},showNoteInput=!1,renderLogs()},e.append(a,r),n.appendChild(e)}d.appendChild(n)})),o.appendChild(d),i<n.length-1){const e=document.createElement("div");e.className="flex space-x-2 mt-2",e.innerHTML=`\n        <section aria-label="jump-controls-${i}" class="jump-controls">\n          <button onclick="scrollToTop()"    class="px-2 py-1 text-xs rounded border" data-ga-event="middle_jump_top">↑ Top</button>\n          <button onclick="scrollToBottom()" class="px-2 py-1 text-xs rounded border" data-ga-event="middle_jump_bottom">↓ Bottom</button>\n        </section>`,d.after(e)}lastEditing={date:editing.date,id:editing.id}}));const i=e.length;updateWelcomeMessage(i),updateJumpControlsVisibility(i),updateClearButtonVisibility(i)}async function saveEdit(e,t,n,a,o){const i={starttimeDisplay:convertTo12hFormat(t),starttimeSortable:t,type:n,notes:a.trim()||null,endtimeDisplay:o?convertTo12hFormat(o):null,endtimeSortable:o||null};await db.activities.update(e,i),editing={date:null,id:null,showEndTime:!1},showNoteInput=!1,await renderLogs()}async function deleteEntry(e){await db.activities.delete(e),cancelEdit(),await renderLogs()}async function confirmClearLog(){await db.activities.clear(),cancelEdit(),closeClearConfirm(),await renderLogs()}function cancelEdit(){editing={date:null,id:null,showEndTime:!1},showNoteInput=!1,renderLogs()}function openClearConfirm(){document.getElementById("clearConfirmModal").classList.replace("hidden","flex")}function closeClearConfirm(){document.getElementById("clearConfirmModal").classList.replace("flex","hidden")}function openModal(){document.getElementById("modal").classList.replace("hidden","flex")}function closeModal(){document.getElementById("modal").classList.replace("flex","hidden")}function scrollToTop(){window.scrollTo({top:0,behavior:"smooth"})}function scrollToBottom(){window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})}function openExportConfirm(){document.getElementById("exportConfirmModal").classList.replace("hidden","flex")}function closeExportConfirm(){document.getElementById("exportConfirmModal").classList.replace("flex","hidden")}function openDatePicker(){const e=document.getElementById("datePicker");e.classList.remove("hidden"),e.focus()}function updateJumpControlsVisibility(e){window.requestAnimationFrame((()=>{const t=document.documentElement.scrollHeight>window.innerHeight,n=e>0&&t?"flex":"none";document.querySelectorAll(".jump-controls").forEach((e=>{e.style.display=n}))}))}function updateClearButtonVisibility(e){const t=document.querySelector('button[onclick="openClearConfirm()"]');t&&(t.style.display=e>0?"inline-block":"none")}function updateWelcomeMessage(e){const t=document.getElementById("welcome-message");0===e?t.classList.remove("hidden"):t.classList.add("hidden")}function convertTo12hFormat(e){let[t,n]=e.split(":").map(Number);const a=t>=12?"PM":"AM";return 0===t?t=12:t>12&&(t-=12),`${t}:${String(n).padStart(2,"0")} ${a}`}function convertToMinutes(e){const[t,n]=e.split(" ");let[a,o]=t.split(":").map(Number);return"PM"===n&&12!==a&&(a+=12),"AM"===n&&12===a&&(a=0),60*a+o}function formatDate(e){const[t,n,a]=e.split("-").map(Number);return`${["January","February","March","April","May","June","July","August","September","October","November","December"][n-1]} ${a}, ${t}`}document.getElementById("export-first-yes").addEventListener("click",(()=>{closeExportConfirm(),document.getElementById("csv-modal").classList.replace("hidden","flex")})),document.getElementById("export-first-no").addEventListener("click",(()=>{closeExportConfirm(),openClearConfirm()})),document.getElementById("datePicker").addEventListener("change",(e=>{const t=e.target.value;e.target.classList.add("hidden");const n=document.querySelector(`section[data-date="${t}"]`);n?n.scrollIntoView({behavior:"smooth",block:"start"}):alert(`No entries for ${t}`),e.target.value=""}));const importBtn=document.getElementById("importExportBtn"),modal=document.getElementById("csv-modal"),exportBtn=document.getElementById("csv-export-btn"),importInput=document.getElementById("csv-import-input"),closeBtn=document.getElementById("csv-modal-close");function parseCSVLine(e){const t=[];let n="",a=!1;for(let o=0;o<e.length;o++){const i=e[o];'"'===i?a&&'"'===e[o+1]?(n+='"',o++):a=!a:","!==i||a?n+=i:(t.push(n),n="")}return t.push(n),t}importBtn.addEventListener("click",(()=>modal.classList.remove("hidden"))),closeBtn.addEventListener("click",(()=>modal.classList.add("hidden"))),exportBtn.addEventListener("click",(async()=>{try{const e=await db.activities.orderBy("[createddate+starttimeSortable]").reverse().toArray(),t=["id","type","createddate","starttime","endtime","notes"],n=e.map((e=>{const t=e=>`"${(e||"").replace(/"/g,'""')}"`;return[e.id,t(e.type),e.createddate,e.starttimeSortable,e.endtimeSortable||"",t(e.notes)].join(",")})),a=[t.join(","),...n].join("\r\n"),o=new Blob([a],{type:"text/csv"}),i=URL.createObjectURL(o),d=document.createElement("a");d.href=i,d.download=`puppy-logs-${(new Date).toISOString().slice(0,10)}.csv`,d.click(),URL.revokeObjectURL(i)}catch(e){alert("Export failed: "+e)}})),importInput.addEventListener("change",(async e=>{const t=e.target.files[0];if(t)try{const e=(await t.text()).split(/\r\n|\n/).filter((e=>e)),[n,...a]=e,o=parseCSVLine(n).map((e=>e.replace(/^"|"$/g,"").replace(/""/g,'"'))),i=e=>o.indexOf(e),d=a.map((e=>{const t=parseCSVLine(e);return{id:Number(t[i("id")]||Date.now()),type:t[i("type")].replace(/^"|"$/g,"").replace(/""/g,'"'),createddate:t[i("createddate")]||"",starttimeSortable:t[i("starttime")]||"",endtimeSortable:t[i("endtime")]||void 0,notes:(t[i("notes")]||"").replace(/^"|"$/g,"").replace(/""/g,'"')||void 0}}));await db.activities.bulkPut(d),renderLogs(),alert("Import successful!")}catch(e){alert("Import failed: "+e)}finally{e.target.value="",modal.classList.add("hidden")}}));